<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wilde Cafe's Simulation</title>
<style>
:root {
  --accent-green: #4caf50;
  --accent-red: #e53935;
  --accent-blue: #1976d2;
  --bg-light: #f7f4ef;
  --font-body: 'Segoe UI', sans-serif;
}

body {
  font-family: var(--font-body);
  background: var(--bg-light);
  max-width: 1100px;
  margin: auto;
  padding: 20px;
  font-size: 17px;
  line-height: 1.6;
  color: #222;
}

h2 { text-align: center; color: var(--accent-blue); }
p { margin-bottom: 1em; }

.arrow { stroke: var(--accent-blue); stroke-width: 2; marker-end: url(#arrowhead); }
.node { fill: #fff; stroke: var(--accent-blue); stroke-width: 2; }
.label { font-family: var(--font-body); font-size: 14px; fill: var(--accent-blue); text-anchor: middle; }

.animate-flow { stroke-dasharray: 120; stroke-dashoffset: 120; animation: flow 1s ease-out forwards; }
@keyframes flow { to { stroke-dashoffset: 0; } }

.profit-positive { color: var(--accent-green); font-weight: bold; }
.profit-negative { color: var(--accent-red); font-weight: bold; }

button {
  background: var(--accent-blue);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s ease;
}
button:hover { background: #145ca0; }

input[type=range] { width: 250px; accent-color: var(--accent-blue); }

.control-section {
  display: flex;
  align-items: center;
  gap: 14px;
  margin: 20px 0;
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* Simple, clean table styling */
.table-wrap{
  background:#fff;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  margin: 14px 0 22px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
  text-align:center;
}

th, td{
  border:1px solid #e6e6e6;
  padding:8px 10px;
}

th{
  background:#f1f5fb;
  font-weight:600;
  color:#123;
}

.small-note{
  margin-top:6px;
  font-size:14px;
  color:#444;
}
</style>
</head>
<body>

<p>
  Welcome! You manage coffee orders between a small coffee shop, Wilde Cafe and their supplier of coffee beans!
  You have a simple goal: try and minimize the amount of inventory that you need, whilst ensuring that you still maintain a profit!
</p>

<!-- PROCESS TABLE (NOW FIRST) -->
<div class="table-wrap">
  <h3 style="margin:0; color:#1976d2;">How the process works (4 steps + 1-week lead time)</h3>
  <div class="small-note">
    <strong>Lead time:</strong> any order placed in <strong>Week N</strong> is delivered at the start of <strong>Week N+1</strong>.
    (e.g., order 50kg in Week 1 → receive it in Week 2).
  </div>

  <table>
    <thead>
      <tr>
        <th>Step</th>
        <th>What happens</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>1) Order</strong></td>
        <td>You decide how many kg to order for delivery next week.</td>
      </tr>
      <tr>
        <td><strong>2) Supplier processes (1 week)</strong></td>
        <td>The supplier prepares your order. It takes <strong>one week</strong> to arrive, and the supplier can fulfil up to <strong>50 kg/week</strong>.</td>
      </tr>
      <tr>
        <td><strong>3) Receive into inventory</strong></td>
        <td>At the <strong>start of the next week</strong>, the delivered quantity is added to your café inventory.</td>
      </tr>
      <tr>
        <td><strong>4) Sell to customers</strong></td>
        <td>Demand happens during the week; you sell what you can from inventory. Any shortage becomes lost sales, which causes you to lose money (as you still need to pay bills).</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- HISTORY TABLE (NOW SECOND) -->
<div class="table-wrap">
  <h3 style="margin:0; color:#1976d2;">Recent history</h3>
  <div class="small-note">
    These are results from the previous few weeks to help you see where you are currently positioned <strong>-3</strong> to <strong>-1</strong>.
  </div>

  <table>
    <thead>
      <tr>
        <th>Week</th>
        <th>Demand (kg)</th>
        <th>Sales (kg)</th>
        <th>End Inventory (kg)</th>
        <th>Profit/Loss</th>
      </tr>
    </thead>
    <tbody id="last3Body">
      <tr><td colspan="5">Loading…</td></tr>
    </tbody>
  </table>
</div>

<!-- Supply chain diagram with dynamic arrows -->
<svg viewBox="0 0 860 150" style="width:100%; margin:20px 0;">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
    </marker>
  </defs>

  <rect class="node" x="10" y="40" width="120" height="50" rx="8"/>
  <text class="label" x="70" y="70">Supplier</text>
  <line id="orderArrow" class="arrow" x1="130" y1="65" x2="250" y2="65"/>
  <text id="orderAmountText" class="label" x="190" y="50"></text>

  <rect class="node" x="250" y="40" width="120" height="50" rx="8"/>
  <text class="label" x="310" y="70">Orders</text>
  <line id="inventoryArrow" class="arrow" x1="370" y1="65" x2="490" y2="65"/>
  <text id="inventoryAmountText" class="label" x="430" y="50"></text>

  <rect class="node" x="490" y="40" width="120" height="50" rx="8"/>
  <text class="label" x="550" y="70">Café Inventory</text>
  <line id="demandArrow" class="arrow" x1="610" y1="65" x2="730" y2="65"/>
  <text id="demandAmountText" class="label" x="670" y="50"></text>

  <rect class="node" x="730" y="40" width="120" height="50" rx="8"/>
  <text class="label" x="790" y="70">Customer Demand</text>
</svg>

<div class="control-section">
  <label>Order kg for next week: <span id="orderDisplay">0</span> kg</label>
  <input type="range" id="orderQty" min="0" max="50" step="5" value="0"
         oninput="orderDisplay.innerText=this.value">
  <button id="nextButton" onclick="nextWeek()">Next Week</button>
</div>

<!-- MAIN LOG TABLE -->
<table>
  <thead>
    <tr>
      <th>Week</th><th>Demand</th><th>Starting Inventory</th><th>Ordered</th>
      <th>Received</th><th>Final Inventory</th><th>Lost Sales</th><th>Cost</th><th>Profit/Loss</th>
    </tr>
  </thead>
  <tbody id="log"></tbody>
</table>

<!-- METRICS TABLE -->
<table class="metric-table">
  <tr><th>Week</th><td id="week">0</td></tr>
  <tr><th>Demand</th><td id="demand">0</td></tr>
  <tr><th>Inventory (kg)</th><td id="inventory">10</td></tr>
  <tr><th>Lost Sales</th><td id="lostSales">0</td></tr>
  <tr><th>Incoming Inventory</th><td id="incoming">0</td></tr>
  <tr><th>Cumulative Profit/Loss</th><td id="cumulativeProfit">$0</td></tr>
</table>

<script>
let week = 0;
let inventory = 10;
let totalProfit = 0;
let pcost = 30;
let scost = 90;
let priceIncrease = false;
const overhead = 1000;
const supplierCap = 50;

function updateArrows(orderPlaced, receivedThisWeek, sold) {
  document.getElementById('orderAmountText').textContent = orderPlaced + ' kg';
  document.getElementById('inventoryAmountText').textContent = receivedThisWeek + ' kg';
  document.getElementById('demandAmountText').textContent = sold + ' kg';

  const orderArrow = document.getElementById('orderArrow');
  const inventoryArrow = document.getElementById('inventoryArrow');
  const demandArrow = document.getElementById('demandArrow');

  [orderArrow, inventoryArrow, demandArrow].forEach(arrow => {
    arrow.classList.remove('animate-flow');
    void arrow.offsetWidth; // force reflow so animation restarts
  });

  if (orderPlaced > 0) orderArrow.classList.add('animate-flow');
  if (receivedThisWeek > 0) inventoryArrow.classList.add('animate-flow');
  if (sold > 0) demandArrow.classList.add('animate-flow');
}

// Hypothetical pre-history (weeks -3, -2, -1). Context only.
const preHistory = [
  { week: 3 weeks ago, demand: 40, sold: 38, endInventory: 12, profit: 320 },
  { week: 2 weeks ago, demand: 55, sold: 50, endInventory: 10, profit: -180 },
  { week: 1 week ago, demand: 70, sold: 60, endInventory: 6,  profit: -620 }
];

function renderPreHistory() {
  const body = document.getElementById('last3Body');
  if (!body) return;

  body.innerHTML = preHistory.map(r => {
    const profitClass = r.profit >= 0 ? 'profit-positive' : 'profit-negative';
    return `
      <tr>
        <td>${r.week}</td>
        <td>${r.demand}</td>
        <td>${r.sold}</td>
        <td>${r.endInventory}</td>
        <td class="${profitClass}">$${r.profit.toFixed(2)}</td>
      </tr>
    `;
  }).join('');
}

/*
  1-week lead time implementation:
  - orderPlacedThisWeek: what the student decides now (arrives next week)
  - incomingNextWeek: what will be received at the start of the next week
*/
let incomingNextWeek = 0;
let warned7000 = false;
let warned14000 = false;
let closedBusiness = false;

function nextWeek() {
  week++;

  // Receive last week's order at the start of this week
  const receivedThisWeek = incomingNextWeek;
  const startingInventory = inventory;
  inventory += receivedThisWeek;

  // Generate demand and sell
  const demand = Math.round(Math.max(5, Math.min(80, randNormal(40, 20))) / 5) * 5;
  const sold = Math.min(demand, inventory);
  const lostSales = demand - sold;
  inventory -= sold;

  // Costs & profit
  const inventoryHoldingCost = inventory * pcost * 0.3;
  const cost = (receivedThisWeek * pcost) + overhead + inventoryHoldingCost;
  const revenue = sold * scost;
  const profit = revenue - cost;
  totalProfit += profit;

  // Now place an order for NEXT week (arrives next week)
  const orderPlacedThisWeek = parseInt(document.getElementById('orderQty').value, 10) || 0;
  incomingNextWeek = Math.min(orderPlacedThisWeek, supplierCap);

  // Alerts
if (totalProfit <= -7000 && !warned7000) {
  alert("You are beginning to face financial distress and the inability to pay your bills: try to reduce your debt to below $7000..");
  warned7000 = true;
}

if (totalProfit <= -15000 && !warned14000) {
  alert("Final warning: the bank may take your business if you do not reduce your debt if you get to $20,000 of debt.");
  warned14000 = true;
}

if (totalProfit <= -20000 && !closedBusiness) {
  alert("The bank has forced your business to close, and you are now the subject of viral videos titled 'the worst places to work where you don't get paid'. Please start again.");
  closedBusiness = true;
  document.getElementById('nextButton').disabled = true;
  return;
}

  // Update diagram arrows
  updateArrows(orderPlacedThisWeek, receivedThisWeek, sold);

  // Update metric table
  const cumulativeProfitCell = document.getElementById('cumulativeProfit');
  cumulativeProfitCell.innerText = "$" + totalProfit.toFixed(2);
  cumulativeProfitCell.className = totalProfit >= 0 ? 'profit-positive' : 'profit-negative';

  document.getElementById('week').innerText = week;
  document.getElementById('demand').innerText = demand;
  document.getElementById('inventory').innerText = inventory;
  document.getElementById('lostSales').innerText = lostSales;
  document.getElementById('incoming').innerText = incomingNextWeek; // incoming for next week

  // Append row to main log
  const row = document.createElement('tr');
  const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

  row.innerHTML = `
    <td>${week}</td>
    <td>${demand}</td>
    <td>${startingInventory}</td>
    <td>${orderPlacedThisWeek}</td>
    <td>${receivedThisWeek}</td>
    <td>${inventory}</td>
    <td>${lostSales}</td>
    <td>$${cost.toFixed(2)}</td>
    <td class="${profitClass}">$${profit.toFixed(2)}</td>
  `;
  document.getElementById('log').appendChild(row);

  // Reset controls
  document.getElementById('orderQty').value = 0;
  document.getElementById('orderDisplay').innerText = 0;

  // END OF GAME CHECK
  if (week === 52) {
    alert("Congratulations! You made it to the end: be sure to make a note of your total profit/loss.");
    document.getElementById('nextButton').disabled = true;
  }
}

function randNormal(mean, stdDev) {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v) * stdDev + mean;
}

// Render the pre-history table on page load
renderPreHistory();
</script>

</body>
</html>
