<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wilde Cafe's Simulation</title>
<style>
:root {
  --accent-green: #4caf50;
  --accent-red: #e53935;
  --accent-blue: #1976d2;
  --bg-light: #f7f4ef;
  --font-body: 'Segoe UI', sans-serif;
}

body {
  font-family: var(--font-body);
  background: var(--bg-light);
  max-width: 1100px;
  margin: auto;
  padding: 20px;
  font-size: 17px;
  line-height: 1.6;
  color: #222;
}

h2 { text-align: center; color: var(--accent-blue); }
p { margin-bottom: 1em; }

.profit-positive { color: var(--accent-green); font-weight: bold; }
.profit-negative { color: var(--accent-red); font-weight: bold; }

button {
  background: var(--accent-blue);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s ease;
}
button:hover { background: #145ca0; }

input[type=range] { width: 250px; accent-color: var(--accent-blue); }

.control-section {
  display: flex;
  align-items: center;
  gap: 14px;
  margin: 20px 0;
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* Simple, clean table styling */
.table-wrap{
  background:#fff;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  margin: 14px 0 22px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
  text-align:center;
}

th, td{
  border:1px solid #e6e6e6;
  padding:8px 10px;
}

th{
  background:#f1f5fb;
  font-weight:600;
  color:#123;
}

.small-note{
  margin-top:6px;
  font-size:14px;
  color:#444;
}

.chart-wrap{
  background:#fff;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  margin: 14px 0 22px;
}
</style>
</head>
<body>

<p>
  Welcome! You manage coffee orders between a small coffee shop, Wilde Cafe and their supplier of coffee beans!
  You have a simple goal: try and minimize the amount of inventory that you need, whilst ensuring that you still maintain a profit!
</p>

<!-- PROCESS TABLE -->
<div class="table-wrap">
  <h3 style="margin:0; color:#1976d2;">How the process works (4 steps + 1-week lead time)</h3>
  <div class="small-note">
    <strong>Lead time:</strong> any order placed in <strong>Week N</strong> is delivered at the start of <strong>Week N+1</strong>.
    (e.g., order 50kg in Week 1 → receive it in Week 2).
  </div>

  <table>
    <thead>
      <tr>
        <th>Step</th>
        <th>What happens</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>1) Order</strong></td>
        <td>You decide how many kg to order for delivery next week.</td>
      </tr>
      <tr>
        <td><strong>2) Supplier processes (1 week)</strong></td>
        <td>The supplier prepares your order. It takes <strong>one week</strong> to arrive, and the supplier can fulfil up to <strong>30 kg/week</strong>.</td>
      </tr>
      <tr>
        <td><strong>3) Receive into inventory</strong></td>
        <td>At the <strong>start of the next week</strong>, the delivered quantity is added to your café inventory.</td>
      </tr>
      <tr>
        <td><strong>4) Sell to customers</strong></td>
        <td>Demand happens during the week; you sell what you can from inventory. Any shortage becomes lost sales, which causes you to lose money (as you still need to pay bills).</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- SLIDER -->
<div class="control-section">
  <label>Order kg for next week: <span id="orderDisplay">0</span> kg</label>
  <input
    type="range"
    id="orderQty"
    min="0"
    max="30"
    step="1"
    value="0"
    oninput="document.getElementById('orderDisplay').innerText=this.value"
  >
  <button id="nextButton" onclick="nextWeek()">Next Week</button>
</div>

<!-- MAIN LOG TABLE -->
<table>
  <thead>
    <tr>
      <th>Week</th>
      <th>Demand</th>
      <th>Sales (kg)</th>
      <th>Carryover Inventory</th>
      <th>Ordered</th>
      <th>Inventory received at start of Week</th>
      <th>Inventory at end of Week</th>
      <th>Revenue</th>
      <th>Cost</th>
      <th>Profit/Loss</th>
    </tr>
  </thead>
  <tbody id="log"></tbody>
</table>

<!-- METRICS TABLE -->
<table class="metric-table">
  <tr><th>Week</th><td id="week">0</td></tr>
  <tr><th>Demand</th><td id="demand">0</td></tr>
  <tr><th>Inventory (kg)</th><td id="inventory">10</td></tr>
  <tr><th>Incoming Inventory</th><td id="incoming">0</td></tr>
  <tr><th>Cumulative Profit/Loss</th><td id="cumulativeProfit">$0</td></tr>
</table>

<!-- PROFIT/LOSS CHART -->
<div class="chart-wrap">
  <h3 style="margin:0; color:#1976d2;">Profit/Loss over time</h3>
  <canvas id="plChart" width="900" height="280"></canvas>
</div>

<script>
let week = 0;
let inventory = 10;
let totalProfit = 0;
const pcost = 30;
const scost = 200;
const overhead = 3000;
const supplierCap = 30;

/*
  1-week lead time:
  - orderPlacedThisWeek: what the student decides now (arrives next week)
  - incomingNextWeek: what will be received at the start of the next week
*/
let incomingNextWeek = 0;
let warned7000 = false;
let warned15000 = false;
let closedBusiness = false;

/* ---- P/L chart state ---- */
const plWeeks = [];
const plValues = [];

function nextWeek() {
  week++;

  // Receive last week's order at the start of this week
  const receivedThisWeek = incomingNextWeek;
  const startingInventory = inventory;
  inventory += receivedThisWeek;

  // Generate demand and sell
  const demand = Math.round(Math.max(5, Math.min(60, randNormal(25, 10))) / 5) * 5;
  const sold = Math.min(demand, inventory);
  inventory -= sold;

  // Revenue, costs & profit (Revenue uses SOLD * selling price)
  const revenue = sold * scost;
  const inventoryHoldingCost = inventory * pcost * 0.3;
  const cost = (receivedThisWeek * pcost) + overhead + inventoryHoldingCost;
  const profit = revenue - cost;
  totalProfit += profit;

  // Place an order for NEXT week (arrives next week)
  const orderPlacedThisWeek = parseInt(document.getElementById('orderQty').value, 10) || 0;
  incomingNextWeek = Math.min(orderPlacedThisWeek, supplierCap);

  // Alerts
  if (totalProfit <= -7000 && !warned7000) {
    alert("You are beginning to face financial distress and the inability to pay your bills: try to reduce your debt to below $7000..");
    warned7000 = true;
  }
  if (totalProfit <= -15000 && !warned15000) {
    alert("Final warning: the bank may will close your business if you get to $20,000 of debt.");
    warned15000 = true;
  }
  if (totalProfit <= -20000 && !closedBusiness) {
    alert("The bank has forced your business to close, and you are now the subject of viral videos titled 'the worst places to work where you don't get paid'. Please start again.");
    closedBusiness = true;
    document.getElementById('nextButton').disabled = true;
    return;
  }

  // Update metric table
  const cumulativeProfitCell = document.getElementById('cumulativeProfit');
  cumulativeProfitCell.innerText = "$" + totalProfit.toFixed(2);
  cumulativeProfitCell.className = totalProfit >= 0 ? 'profit-positive' : 'profit-negative';

  document.getElementById('week').innerText = week;
  document.getElementById('demand').innerText = demand;
  document.getElementById('inventory').innerText = inventory;
  document.getElementById('incoming').innerText = incomingNextWeek; // incoming for next week

  // Append row to main log
  const row = document.createElement('tr');
  const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

  row.innerHTML = `
    <td>${week}</td>
    <td>${demand}</td>
    <td>${sold}</td>
    <td>${startingInventory}</td>
    <td>${orderPlacedThisWeek}</td>
    <td>${receivedThisWeek}</td>
    <td>${inventory}</td>
    <td>$${revenue.toFixed(2)}</td>
    <td>$${cost.toFixed(2)}</td>
    <td class="${profitClass}">$${profit.toFixed(2)}</td>
  `;
  document.getElementById('log').appendChild(row);

  // Update chart
  plWeeks.push(week);
  plValues.push(profit);
  updateChart();

  // Reset controls
  document.getElementById('orderQty').value = 0;
  document.getElementById('orderDisplay').innerText = 0;

  // END OF GAME CHECK
  if (week === 30) {
    alert("Congratulations! You made it to the end: be sure to make a note of your total profit/loss.");
    document.getElementById('nextButton').disabled = true;
  }
}

function randNormal(mean, stdDev) {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v) * stdDev + mean;
}

/* ---------- Minimal no-dependency line chart ---------- */
function updateChart() {
  const canvas = document.getElementById('plChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  // Frame
  const m = { left: 60, right: 20, top: 24, bottom: 36 };
  const PW = W - m.left - m.right;
  const PH = H - m.top - m.bottom;

  // Axes box
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  ctx.strokeRect(m.left, m.top, PW, PH);

  // Title
  ctx.fillStyle = '#123';
  ctx.font = 'bold 14px Segoe UI';
  ctx.fillText('Profit/Loss by Week', m.left, 16);

  if (plValues.length === 0) return;

  const minX = Math.min(...plWeeks);
  const maxX = Math.max(...plWeeks);
  let minY = Math.min(...plValues);
  let maxY = Math.max(...plValues);
  if (minY === maxY) { minY -= 1; maxY += 1; }
  const padY = (maxY - minY) * 0.1 || 1;
  minY -= padY; maxY += padY;

  const xScale = x => m.left + ((x - minX) / (maxX - minX || 1)) * PW;
  const yScale = y => m.top + (1 - (y - minY) / (maxY - minY)) * PH;

  // Y grid & labels
  ctx.strokeStyle = '#eee';
  ctx.fillStyle = '#666';
  ctx.font = '12px Segoe UI';
  const yTicks = 5;
  for (let i = 0; i <= yTicks; i++) {
    const t = i / yTicks;
    const y = m.top + t * PH;
    ctx.beginPath();
    ctx.moveTo(m.left, y);
    ctx.lineTo(m.left + PW, y);
    ctx.stroke();
    const val = (maxY - (maxY - minY) * t);
    ctx.fillText('$' + val.toFixed(0), 8, y + 4);
  }

  // X ticks (weeks)
  const xStep = Math.max(1, Math.floor((maxX - minX) / 6));
  ctx.strokeStyle = '#aaa';
  for (let x = minX; x <= maxX; x += xStep) {
    const px = xScale(x);
    ctx.beginPath();
    ctx.moveTo(px, m.top + PH);
    ctx.lineTo(px, m.top + PH + 4);
    ctx.stroke();
    ctx.fillText('W' + x, px - 10, H - 10);
  }

  // Zero line
  if (minY < 0 && maxY > 0) {
    const zy = yScale(0);
    ctx.strokeStyle = '#e53935';
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(m.left, zy);
    ctx.lineTo(m.left + PW, zy);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Line
  ctx.strokeStyle = '#1976d2';
  ctx.lineWidth = 2;
  ctx.beginPath();
  plWeeks.forEach((x, i) => {
    const px = xScale(x);
    const py = yScale(plValues[i]);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  });
  ctx.stroke();
}

// Draw empty axes on load
updateChart();
</script>

</body>
</html>
